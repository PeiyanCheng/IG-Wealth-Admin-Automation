<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Insurance Illustration → LPP Standardized CSV</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  margin: 0;
  background: #f4f6f8;
  font-family: Inter, Arial, sans-serif;
  color: #333;
}

.page-container {
  max-width: 1320px;
  margin: 32px auto;
  padding: 32px;
  background: #fff;
  border-radius: 18px;
  overflow: hidden;
}

/* ===== Title ===== */
.page-title {
  text-align: center;
  font-family: 'Playfair Display', serif;
  font-size: 36px;
  font-weight: 700;
}

.page-subtitle {
  text-align: center;
  font-size: 14px;
  color: #666;
  margin-bottom: 24px;
}

/* ===== Actions ===== */
.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.left-actions, .right-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}

.btn-upload {
  background: #e8f5e9;
  border: 1px solid #66bb6a;
  color: #2e7d32;
}

.btn-primary {
  background: #1976d2;
  border: none;
  color: #fff;
}

.file-input { display: none; }

/* ===== File Tabs ===== */
.file-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.file-tab {
  padding: 6px 14px;
  border-radius: 14px;
  font-size: 12px;
  cursor: pointer;
  background: #e0e0e0;
}

.file-tab.active {
  background: #1976d2;
  color: #fff;
}

/* ===== Preview ===== */
.preview-section {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 24px;
}

.preview-flex {
  display: flex;
  gap: 24px;
}

@media (max-width: 900px) {
  .preview-flex { flex-direction: column; }
}

/* ===== Cards ===== */
.card {
  box-sizing: border-box;
  flex: 1;
  min-width: 0;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.card-illustration { background: #f1fbf4; }
.card-lpp { background: #f1f7ff; }
.card-admin { background: #f6f7f8; margin-bottom: 24px; }

.card h3 {
  margin: 0 0 10px 0;
  font-size: 16px;
}

/* ===== Tables ===== */
.table-scroll {
  max-height: 320px;
  overflow-x: auto;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
}

table {
  border-collapse: collapse;
  font-size: 12px;
  width: max-content;
  background: #fff;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 6px;
  white-space: nowrap;
  text-align: right;
}

th {
  position: sticky;
  top: 0;
  background: #f1f3f6;
  z-index: 3;
}

.freeze-first-col th:first-child,
.freeze-first-col td:first-child {
  position: sticky;
  left: 0;
  background: #fafafa;
  z-index: 2;
}

.highlight { background: #fff7cc; }

/* ===== Rules ===== */
.rule-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 8px;
}

.rule-label {
  width: 220px;
  font-weight: 600;
  font-size: 13px;
}

.rule-input {
  flex: 1;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #bbb;
  font-size: 13px;
}

.rule-hint {
  font-size: 12px;
  color: #555;
  margin-bottom: 10px;
}
</style>
</head>

<body>
<div class="page-container">

<div class="page-title">Insurance Illustration → LPP Standardized CSV</div>
<div class="page-subtitle">Client-safe output with Admin rule control</div>

<div class="action-bar">
  <div class="left-actions">
    <label class="btn btn-upload">
      Upload illustration files
      <input id="fileInput" class="file-input" type="file" multiple onchange="processFiles()">
    </label>
    <button class="btn btn-primary" onclick="downloadCurrent()">Download current CSV</button>
    <button class="btn btn-primary" onclick="downloadAll()">Download all CSVs</button>
  </div>

  <div class="right-actions">
    <label>Mode:</label>
    <select id="modeSelect" onchange="applyMode()">
      <option value="client">Client mode</option>
      <option value="admin">Admin mode</option>
    </select>
  </div>
</div>

<div id="fileTabs" class="file-tabs"></div>

<div class="preview-section">
  <div class="preview-flex">

    <div id="adminOnlyIllustration" class="card card-illustration">
      <h3>Original illustration (Admin)</h3>
      <div id="originalPreview" class="table-scroll"></div>
    </div>

    <div class="card card-lpp">
      <h3>LPP standardized preview</h3>
      <div id="csvPreview" class="table-scroll"></div>
    </div>

  </div>
</div>

<div id="adminOnlyRules" class="card card-admin">
  <h3>Field matching rules (Admin)</h3>
  <div class="rule-hint">
    Use <b>|</b> to separate <b>OR</b> conditions.<br>
    Example: <code>death benefit | payout on death | total death</code>
  </div>
  <div id="rulesContainer"></div>
</div>

<script>
/* ===== Configuration ===== */
const TEMPLATE_FIELDS = [
  "Annual premium",
  "Cash surrender value",
  "Death benefit",
  "Adjusted cost basis",
  "CDA credit",
  "Dividends paid in cash",
  "Taxable portion of dividends",
  "Net cost of pure insurance",
  "Premiums paid by policy"
];

const DEFAULT_RULES = {
  "Annual premium": "premium | annualized premium | monthly premium",
  "Cash surrender value": "cash surrender | cash value",
  "Death benefit": "death benefit | payout on death | total death",
  "Adjusted cost basis": "acb | adjusted cost basis",
  "CDA credit": "cda | capital dividend",
  "Dividends paid in cash": "dividend cash | cash dividend",
  "Taxable portion of dividends": "taxable dividend",
  "Net cost of pure insurance": "ncpi | cost of insurance",
  "Premiums paid by policy": "premium dividend"
};

/* ===== State ===== */
let results = {};
let fileOrder = [];
let currentFile = "";
let rules = { ...DEFAULT_RULES };

/* ===== Init ===== */
window.onload = () => {
  renderRules();
  applyMode();
};

/* ===== Mode ===== */
function applyMode() {
  const isAdmin = document.getElementById("modeSelect").value === "admin";
  document.getElementById("adminOnlyIllustration").style.display = isAdmin ? "block" : "none";
  document.getElementById("adminOnlyRules").style.display = isAdmin ? "block" : "none";
}

/* ===== Rules UI ===== */
function renderRules() {
  const container = document.getElementById("rulesContainer");
  container.innerHTML = "";
  TEMPLATE_FIELDS.forEach(field => {
    const row = document.createElement("div");
    row.className = "rule-row";
    row.innerHTML = `
      <div class="rule-label">${field}</div>
      <input class="rule-input" value="${rules[field] || ""}"
        oninput="rules['${field}']=this.value">
    `;
    container.appendChild(row);
  });
}

/* ===== Helpers ===== */
const normalize = t => String(t || "").toLowerCase();
function formatNumber(v) {
  const n = Number(v);
  return isNaN(n) ? "0.00" : n.toFixed(2);
}

/* ===== Processing ===== */
function processFiles() {
  const files = document.getElementById("fileInput").files;
  results = {};
  fileOrder = [];
  currentFile = "";

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(e.target.result, { type: "binary" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const headers = data[0];
      const rows = data.slice(1);

      let matchedIndexes = [];
      let outputRows = rows.map(row => {
        let out = {};
        TEMPLATE_FIELDS.forEach(field => {
          let rule = rules[field] || "";
          let idx = headers.findIndex(h =>
            rule.split("|").some(k => normalize(h).includes(normalize(k.trim())))
          );
          let val = idx >= 0 ? row[idx] : 0;
          if (idx >= 0 && normalize(headers[idx]).includes("monthly") && !isNaN(val)) {
            val *= 12;
          }
          out[field] = val || 0;
          if (idx >= 0) matchedIndexes.push(idx);
        });
        return out;
      });

      results[file.name] = { headers, rows, matchedIndexes, outputRows };
      fileOrder.push(file.name);
      if (!currentFile) currentFile = file.name;
      renderTabs();
      render();
    };
    reader.readAsBinaryString(file);
  });
}

/* ===== Tabs ===== */
function renderTabs() {
  const tabs = document.getElementById("fileTabs");
  tabs.innerHTML = "";
  fileOrder.forEach(name => {
    const t = document.createElement("div");
    t.className = "file-tab" + (name === currentFile ? " active" : "");
    t.innerText = name;
    t.onclick = () => { currentFile = name; renderTabs(); render(); };
    tabs.appendChild(t);
  });
}

/* ===== Render ===== */
function render() {
  const data = results[currentFile];
  if (!data) return;

  let orig = "<table class='freeze-first-col'><thead><tr>";
  data.headers.forEach(h => orig += `<th>${h}</th>`);
  orig += "</tr></thead><tbody>";
  data.rows.forEach(r => {
    orig += "<tr>";
    r.forEach((c,i) => orig += `<td class="${data.matchedIndexes.includes(i)?"highlight":""}">${c ?? ""}</td>`);
    orig += "</tr>";
  });
  orig += "</tbody></table>";
  document.getElementById("originalPreview").innerHTML = orig;

  let lpp = "<table><thead><tr>";
  TEMPLATE_FIELDS.forEach(h => lpp += `<th>${h}</th>`);
  lpp += "</tr></thead><tbody>";
  data.outputRows.forEach(r => {
    lpp += "<tr>";
    TEMPLATE_FIELDS.forEach(h => lpp += `<td>${formatNumber(r[h])}</td>`);
    lpp += "</tr>";
  });
  lpp += "</tbody></table>";
  document.getElementById("csvPreview").innerHTML = lpp;
}

/* ===== Download ===== */
function downloadCurrent() {
  if (currentFile) saveCSV(currentFile);
}
function downloadAll() {
  fileOrder.forEach(saveCSV);
}
function saveCSV(name) {
  const rows = results[name].outputRows;
  let csv = TEMPLATE_FIELDS.join(",") + "\n";
  rows.forEach(r => {
    csv += TEMPLATE_FIELDS.map(h => r[h]).join(",") + "\n";
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = `LPP-Updated-${name.replace(/\.[^/.]+$/, "")}.csv`;
  a.click();
}
</script>

</div>
</body>
</html>
