<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LPP Insurance CSV Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>
  <h2>LPP Insurance Illustration → CSV</h2>

  <input type="file" id="fileInput" />
  <button onclick="processFile()">Generate CSV</button>

  <script>
    const TEMPLATE_HEADERS = [
      "Annual premium",
      "Cash surrender value",
      "Death benefit",
      "Adjusted cost basis",
      "CDA credit",
      "Dividends paid in cash",
      "Taxable portion of dividends",
      "Net cost of pure insurance",
      "Premiums paid by policy"
    ];

    const FIELD_MAPPING = {
      "Annual premium": [
        "Total Annual Policy Premium",
        "Total yearly premium",
        "Total annual premium",
        "Premiums paid by client (Current rate)"
      ],
      "Cash surrender value": [
        "Cash surrender value (Current rate)",
        "Total cash value (Primary)"
      ],
      "Death benefit": [
        "Total Policy Death Benefit",
        "Total death benefit (Primary)",
        "Total death benefit (Current rate)",
        "Total payout on death ($)"
      ],
      "Adjusted cost basis": [
        "ACB",
        "Adjusted cost basis (Primary)",
        "ACB (Current rate)"
      ],
      "CDA credit": [
        "CDA Credit",
        "Capital dividend account credit (Primary)",
        "CDA credit (Current rate)"
      ],
      "Dividends paid in cash": [
        "Dividends paid in cash (Current rate)",
        "Annual dividend (Primary)"
      ],
      "Taxable portion of dividends": [
        "Taxable Portion of Dividends (Current rate)"
      ],
      "Net cost of pure insurance": [
        "NCPI",
        "Net cost of pure insurance (Primary)",
        "NCPI (Current rate)"
      ],
      "Premiums paid by policy": [
        "Premiums paid by client (Current rate)"
      ]
    };

    function processFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("Please select a file");
        return;
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = data[0];
        const rows = data.slice(1); // 所有数据行

        let outputRows = [];

        rows.forEach(row => {
          let outputRow = {};

          TEMPLATE_HEADERS.forEach(target => {
            let value = "";

            (FIELD_MAPPING[target] || []).forEach(source => {
              const idx = headers.indexOf(source);
              if (idx !== -1 && value === "") {
                value = row[idx];
              }
            });

            outputRow[target] = value || "";
          });

          outputRows.push(outputRow);
        });

        downloadCSV(outputRows, file.name);
      };

      reader.readAsBinaryString(file);
    }

    function downloadCSV(rows, originalFileName) {
      let csv = TEMPLATE_HEADERS.join(",") + "\n";

      rows.forEach(row => {
        csv += TEMPLATE_HEADERS.map(h => row[h]).join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);

      const baseName = originalFileName.replace(/\.[^/.]+$/, "");
      link.download = `LPP-Updated-${baseName}.csv`;

      link.click();
    }
  </script>
</body>
</html>
