<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>LPP Insurance Illustration → CSV</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { background:#f7f9fb; font-family:Arial,sans-serif; margin:0; }
.page-container { max-width:1200px; margin:auto; padding:24px; background:#fff; }
.page-title { text-align:center; font-size:32px; font-weight:700; margin-bottom:24px; }
.action-bar { display:flex; justify-content:center; gap:16px; margin-bottom:24px; flex-wrap:wrap; }
.primary-btn { background:#1976d2; color:#fff; border:none; padding:12px 20px; border-radius:6px; font-weight:600; cursor:pointer; }
.secondary-btn { background:#fff; color:#1976d2; border:1px solid #1976d2; padding:12px 20px; border-radius:6px; font-weight:600; cursor:pointer; }
.primary-btn:disabled { background:#b0bec5; cursor:not-allowed; }
table { border-collapse:collapse; font-size:12px; }
th,td { border:1px solid #ccc; padding:4px; white-space:nowrap; }
.highlight { background:#fff3cd; }
.table-scroll { max-height:320px; overflow:auto; border:1px solid #ccc; }
.table-scroll table { width:max-content; min-width:100%; }
textarea { width:700px; font-family:monospace; font-size:12px; }
.log { border:1px solid #ccc; padding:6px; margin:6px 0; font-size:12px; }
.suggest { cursor:pointer; color:#1976d2; text-decoration:underline; }
.metric { font-weight:600; margin:8px 0; }
</style>
</head>

<body>
<div class="page-container">

<div class="page-title">LPP Insurance Illustration → CSV</div>

<div class="action-bar">
  <input type="file" id="fileInput">
  <button class="secondary-btn" onclick="processFile()">Process</button>
  <button class="primary-btn" id="downloadBtn" onclick="downloadCSV()" disabled>
    Confirm & Download CSV
  </button>
</div>

<div id="productInfo"></div>
<div id="coverageInfo" class="metric"></div>

<h3>Field Matching Rules</h3>
<p>
• Each line = AND<br>
• <code>||</code> = OR<br>
• Click a suggestion to auto-add rule
</p>

<table id="ruleTable">
<tr><th>LPP Field</th><th>Rules</th></tr>
</table>

<div style="display:flex; gap:20px; margin-top:20px;">
  <div style="width:50%;">
    <h3>Original Illustration</h3>
    <div id="originalPreview"></div>
  </div>
  <div style="width:50%;">
    <h3>LPP Template</h3>
    <div id="csvPreview"></div>
  </div>
</div>

<h3>Match Explanation & Suggestions</h3>
<div id="explainArea"></div>

<script>
/* ===== CONFIG ===== */
const TEMPLATE_HEADERS=[
"Annual premium","Cash surrender value","Death benefit","Adjusted cost basis",
"CDA credit","Dividends paid in cash","Taxable portion of dividends",
"Net cost of pure insurance","Premiums paid by policy"
];

const DEFAULT_RULES={
"Annual premium":"premium\n||\ntotal monthly premium\n||\ntotal annualized premium",
"Death benefit":"death benefit\n||\npayout on death\n||\ntotal death",
"Cash surrender value":"cash surrender\n||\ncash value",
"Adjusted cost basis":"acb\n||\nadjusted cost basis",
"CDA credit":"cda\n||\ncapital dividend account credit",
"Dividends paid in cash":"dividend cash\n||\ncash dividend",
"Taxable portion of dividends":"taxable dividend",
"Net cost of pure insurance":"ncpi\n||\ncost of insurance",
"Premiums paid by policy":"premium dividend"
};

let processedRows=[], matchedIdx=[], explanations=[], coverageStats={};

/* ===== INIT ===== */
window.onload=()=>{
  const rules=JSON.parse(localStorage.getItem("lpp_rules")||"null")||DEFAULT_RULES;
  const t=document.getElementById("ruleTable");
  Object.entries(rules).forEach(([f,r])=>{
    const row=t.insertRow();
    row.insertCell().innerText=f;
    row.insertCell().innerHTML=`<textarea rows="4">${r}</textarea>`;
  });
};

/* ===== HELPERS ===== */
const norm=t=>t.toLowerCase().trim();

function matchRule(header,rule){
  const h=norm(header);
  const groups=rule.split("||").map(g=>g.trim()).filter(Boolean);
  for(const g of groups){
    const words=g.split(/\s+/);
    const hit=words.filter(w=>h.includes(w)).length;
    if(hit===words.length){
      return {matched:true,rule:g,confidence:"High"};
    }
  }
  return {matched:false};
}

function suggest(headers,rule){
  const out=[];
  const groups=rule.split("||").map(g=>g.trim()).filter(Boolean);
  headers.forEach(h=>{
    const hn=norm(h);
    groups.forEach(g=>{
      const w=g.split(/\s+/);
      const hit=w.filter(x=>hn.includes(x)).length;
      if(hit>0 && hit<w.length){
        out.push({h,score:(hit/w.length).toFixed(2),rule:g});
      }
    });
  });
  return out.sort((a,b)=>b.score-a.score).slice(0,3);
}

/* ===== CORE ===== */
function processFile(){
  const f=document.getElementById("fileInput").files[0];
  if(!f) return;

  explanations=[]; matchedIdx=[]; processedRows=[]; coverageStats={matched:0,total:TEMPLATE_HEADERS.length};

  const rules={};
  [...document.querySelectorAll("#ruleTable tr")].slice(1).forEach(r=>{
    rules[r.cells[0].innerText]=r.cells[1].querySelector("textarea").value;
  });
  localStorage.setItem("lpp_rules",JSON.stringify(rules));

  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    const data=XLSX.utils.sheet_to_json(sh,{header:1});
    const headers=data[0], rows=data.slice(1);

    processedRows=rows.map(row=>{
      const out={};
      TEMPLATE_HEADERS.forEach(field=>{
        let idx=-1,info;
        headers.forEach((h,i)=>{
          const m=matchRule(h,rules[field]);
          if(m.matched && idx===-1){idx=i;info=m;}
        });
        if(idx!==-1){
          let v=row[idx];
          if(norm(headers[idx]).includes("monthly") && !isNaN(v)) v*=12;
          out[field]=v||0;
          matchedIdx.push(idx);
          coverageStats.matched++;
          explanations.push(`${field} ← "${headers[idx]}" (${info.rule})`);
        }else{
          out[field]=0;
          const sug=suggest(headers,rules[field]);
          if(sug.length){
            explanations.push(`⚠ ${field}: `+
              sug.map(s=>`<span class="suggest" onclick="addRule('${field}','${s.rule}')">${s.h} (${s.score})</span>`).join(" | ")
            );
          }
        }
      });
      return out;
    });

    render(headers,rows);
    document.getElementById("coverageInfo").innerText=
      `Rule coverage: ${coverageStats.matched}/${coverageStats.total} (${Math.round(coverageStats.matched/coverageStats.total*100)}%)`;
    document.getElementById("downloadBtn").disabled=false;
  };
  reader.readAsBinaryString(f);
}

function addRule(field,rule){
  const rows=[...document.querySelectorAll("#ruleTable tr")].slice(1);
  rows.forEach(r=>{
    if(r.cells[0].innerText===field){
      const ta=r.cells[1].querySelector("textarea");
      ta.value+=`\n||\n${rule}`;
    }
  });
  alert("Rule added. Click Process again.");
}

/* ===== RENDER ===== */
function render(headers,rows){
  let l="<table><tr>";
  headers.forEach((h,i)=>{if(matchedIdx.includes(i)) l+=`<th class="highlight">${h}</th>`});
  l+="</tr>";
  rows.forEach(r=>{
    l+="<tr>";
    headers.forEach((_,i)=>{if(matchedIdx.includes(i)) l+=`<td class="highlight">${r[i]}</td>`});
    l+="</tr>";
  });
  l+="</table>";

  let r="<table><tr>";
  TEMPLATE_HEADERS.forEach(h=>r+=`<th>${h}</th>`);
  r+="</tr>";
  processedRows.forEach(x=>{
    r+="<tr>";
    TEMPLATE_HEADERS.forEach(h=>r+=`<td>${x[h]}</td>`);
    r+="</tr>";
  });
  r+="</table>";

  document.getElementById("originalPreview").innerHTML=`<div class="table-scroll">${l}</div>`;
  document.getElementById("csvPreview").innerHTML=`<div class="table-scroll">${r}</div>`;
  document.getElementById("explainArea").innerHTML=explanations.map(e=>`<div class="log">${e}</div>`).join("");
}

/* ===== DOWNLOAD ===== */
function downloadCSV(){
  const base=document.getElementById("fileInput").files[0].name.replace(/\.[^/.]+$/,"");
  let csv=TEMPLATE_HEADERS.join(",")+"\n";
  processedRows.forEach(r=>csv+=TEMPLATE_HEADERS.map(h=>r[h]).join(",")+"\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`LPP-Updated-${base}.csv`;
  a.click();
}
</script>

</div>
</body>
</html>
