<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily Birthday Automation</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .advisor-btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #fff; cursor: pointer; font-size: 13px; margin: 4px; }
        .advisor-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
        .var-container { margin: 15px 0; padding: 12px; background: #f0f7ff; border-radius: 8px; border: 1px solid #d0e3ff; }
        .var-tag { display: inline-block; background: #fff; border: 1px solid #1976d2; color: #1976d2; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin: 3px; cursor: pointer; font-weight: 600; }
        textarea { width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Inter', sans-serif; font-size: 13px; margin: 10px 0; box-sizing: border-box; }
        
        /* Instruction Section Styling */
        .instruction-box { background: #fff8e1; border-left: 5px solid #ffc107; padding: 20px; margin-top: 30px; border-radius: 8px; }
        .step-num { display: inline-block; width: 24px; height: 24px; background: #ffc107; color: #000; text-align: center; border-radius: 50%; font-weight: bold; margin-right: 10px; }
        .instruction-step { margin-bottom: 15px; font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="../index.html" class="nav-brand"><span>‚Üê Back to Dashboard</span></a>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Daily Birthday Automation</h1>
            <div style="font-size: 14px; color: #666;">IG Wealth Admin Automation Tool</div>
        </div>

        <div class="card" style="text-align: center; margin-bottom: 25px;">
            <label class="btn btn-upload">üìÇ Upload Birthday Report<input id="fileInput" style="display:none;" type="file" onchange="loadFile()"></label>
            <div id="fileStatus" style="margin-top: 10px; font-size: 13px; color: #1976d2;">Ready to process file</div>
        </div>

        <div id="advisorSection" class="card" style="display:none; margin-bottom: 25px;">
            <h3>Select Servicing Advisor</h3>
            <div id="advisorList"></div>
        </div>

        <div id="mainSection" class="card" style="display:none;">
            <h3>Generate VBA Data File</h3>
            
            <div class="var-container">
                <span class="var-tag" onclick="insertVar('{{FirstName}}')">{{FirstName}}</span>
                <span class="var-tag" onclick="insertVar('{{AdvisorName}}')">{{AdvisorName}}</span>
            </div>

            <textarea id="bodyInput">Dear {{FirstName}},

Wishing you a fantastic birthday!

Best regards,
Yan Cheng</textarea>

            <button class="btn btn-primary" onclick="downloadVbaExcel()" style="width: 100%; padding: 15px;">Download Yan_Cheng_Birthday_Automation.xlsx</button>
        </div>

        <div class="instruction-box">
            <h2 style="margin-top:0;">üìã How to use this file with Outlook</h2>
            <p>Follow these simple steps to link this data to your automated Outlook drafts:</p>
            
            <div class="instruction-step">
                <span class="step-num">1</span> 
                <strong>Open your Master VBA Template:</strong> Open the Excel file that contains your "SendBirthdayEmails" macro.
            </div>

            <div class="instruction-step">
                <span class="step-num">2</span> 
                <strong>Clear Old Data:</strong> Go to the sheet where client names are stored and delete any old information.
            </div>

            <div class="instruction-step">
                <span class="step-num">3</span> 
                <strong>Copy & Paste:</strong> Open the <em>Yan_Cheng_Birthday_Automation.xlsx</em> file you just downloaded. Copy all the data and paste it into your Master VBA Template.
            </div>

            <div class="instruction-step">
                <span class="step-num">4</span> 
                <strong>Run Macro:</strong> Click the "Run" button (or press <code>Alt + F8</code>) and select <b>SendBirthdayEmails</b>. Outlook will now create your drafts!
            </div>
            
            <p style="font-size: 12px; color: #777; font-style: italic; margin-top: 10px;">
                Note: Ensure your Outlook is open before running the script.
            </p>
        </div>
    </div>

    <script>
        let rawData = [], headers = [], selectedAdvisor = null;
        let advIdx = -1, nameIdx = -1, emailIdx = -1, dateIdx = -1;

        function loadFile() {
            const file = document.getElementById("fileInput").files[0];
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array', cellDates: true});
                const allRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                
                // Find the header row containing Servicing Advisor
                let hRow = allRows.findIndex(row => row.some(cell => String(cell || "").includes("Servicing Advisor")));
                if (hRow === -1) hRow = 0;

                headers = allRows[hRow].map(h => String(h || "").trim());
                rawData = allRows.slice(hRow + 1);
                
                advIdx = headers.indexOf("Servicing Advisor");
                nameIdx = headers.findIndex(h => /name/i.test(h));
                emailIdx = headers.findIndex(h => /email|primary/i.test(h));
                dateIdx = headers.findIndex(h => /birth|date/i.test(h));

                document.getElementById("fileStatus").innerText = "Loaded " + rawData.length + " rows.";
                
                if (advIdx !== -1) {
                    renderAdvisors();
                    document.getElementById("advisorSection").style.display = "block";
                }
                document.getElementById("mainSection").style.display = "block";
            };
            reader.readAsArrayBuffer(file);
        }

        function renderAdvisors() {
            const list = [...new Set(rawData.map(r => r[advIdx]))].filter(Boolean).sort();
            const container = document.getElementById("advisorList");
            container.innerHTML = "";
            list.forEach(adv => {
                const btn = document.createElement("button");
                btn.className = "advisor-btn"; btn.innerText = adv;
                btn.onclick = () => {
                    selectedAdvisor = adv;
                    document.querySelectorAll('.advisor-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                container.appendChild(btn);
            });
        }

        function insertVar(text) {
            const el = document.getElementById("bodyInput");
            const s = el.selectionStart;
            el.value = el.value.substring(0, s) + text + el.value.substring(el.selectionEnd);
            el.focus();
        }

        function downloadVbaExcel() {
            let filtered = rawData;
            if (advIdx !== -1 && selectedAdvisor) {
                filtered = rawData.filter(r => r[advIdx] === selectedAdvisor);
            }

            // Standardized Column Output for VBA: A: Name, B: Date, C: Email
            const exportData = [["Name", "Birthdate", "Email"]];
            filtered.forEach(c => {
                exportData.push([c[nameIdx], c[dateIdx], c[emailIdx]]);
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "Yan_Cheng_Birthday_Automation.xlsx");
        }
    </script>
</body>
</html>
