<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Birthday Automation - IG Wealth Admin</title>

<link rel="stylesheet" href="../style.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    /* # Section: Tool Specific Styles */
    .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 900px) { .config-grid { grid-template-columns: 1fr; } }
    .advisor-btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #fff; cursor: pointer; font-size: 13px; margin: 4px; transition: 0.2s; }
    .advisor-btn.active { background: var(--primary); color: white; font-weight: 600; }
    textarea { width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Inter', sans-serif; font-size: 13px; margin: 10px 0; box-sizing: border-box; }
    .email-preview { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 8px; font-size: 13px; white-space: pre-wrap; color: #444; }
    .var-tag { display: inline-block; padding: 4px 8px; background: #e3f2fd; color: #1565c0; border-radius: 4px; font-size: 11px; margin: 5px 5px 0 0; cursor: pointer; border: 1px solid #bbdefb; }
</style>
</head>

<body>

<nav class="navbar">
    <a href="../index.html" class="nav-brand"><span>‚Üê Back to Dashboard</span></a>
</nav>

<div class="container">
    <div class="page-header">
        <h1 class="page-title">Birthday Email Automation</h1>
        <div style="font-size: 14px; color: #666;">IG Wealth Admin Automation Tool</div>
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
        <label class="btn btn-upload">
            üìÇ Upload Master Client List
            <input id="fileInput" style="display:none;" type="file" onchange="loadFile()">
        </label>
        <div id="fileStatus" style="margin-top: 10px; font-size: 13px; color: var(--primary);"></div>
    </div>

    <div id="advisorSection" class="card" style="display:none; margin-bottom: 24px;">
        <h3>1. Select Servicing Advisor</h3>
        <div id="advisorList"></div>
    </div>

    <div id="mainSection" class="config-grid" style="display:none;">
        <div class="card">
            <h3>2. Template Editor</h3>
            <label style="font-size:12px; font-weight:600;">Subject Line</label>
            <input type="text" id="subjectInput" value="Happy Birthday {{FirstName}}! üéâ" oninput="renderPreview()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            
            <div style="margin-bottom:8px;">
                <span class="var-tag" onclick="insertVar('{{FirstName}}')">+ First Name</span>
                <span class="var-tag" onclick="insertVar('{{Advisor}}')">+ Advisor</span>
            </div>
            <textarea id="bodyInput" oninput="renderPreview()">Dear {{FirstName}},

Wishing you a wonderful birthday!

Best regards,
{{Advisor}}</textarea>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">3. Preview & Export</h3>
                <button class="btn btn-primary" onclick="downloadExcel()">Download Smart Excel</button>
            </div>
            <div class="email-preview" id="previewArea">Select an advisor to preview...</div>
        </div>
    </div>
</div>

<script>
    /* # Section: JavaScript Logic for Birthday Automation */
    let rawData = [], headers = [], selectedAdvisor = "";

    function loadFile() {
        const file = document.getElementById("fileInput").files[0];
        const reader = new FileReader();
        reader.onload = e => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            headers = jsonData[0]; rawData = jsonData.slice(1);
            document.getElementById("fileStatus").innerText = "Loaded: " + file.name;
            renderAdvisorButtons();
            document.getElementById("advisorSection").style.display = "block";
            document.getElementById("mainSection").style.display = "grid";
        };
        reader.readAsArrayBuffer(file);
    }

    function renderAdvisorButtons() {
        let advIdx = headers.findIndex(h => /advisor/i.test(h)) || 0;
        const list = [...new Set(rawData.map(r => r[advIdx]))].filter(Boolean).sort();
        const container = document.getElementById("advisorList");
        container.innerHTML = "";
        list.forEach(adv => {
            const btn = document.createElement("button");
            btn.className = "advisor-btn"; btn.innerText = adv;
            btn.onclick = () => {
                selectedAdvisor = adv;
                document.querySelectorAll('.advisor-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); renderPreview();
            };
            container.appendChild(btn);
        });
    }

    function renderPreview() {
        if (!selectedAdvisor) return;
        const subj = document.getElementById("subjectInput").value.replace("{{FirstName}}", "Client").replace("{{Advisor}}", selectedAdvisor);
        const body = document.getElementById("bodyInput").value.replace("{{FirstName}}", "Client").replace("{{Advisor}}", selectedAdvisor);
        document.getElementById("previewArea").innerText = `Subject: ${subj}\n\n${body}`;
    }

    function insertVar(text) {
        const el = document.getElementById("bodyInput");
        const s = el.selectionStart;
        el.value = el.value.substring(0, s) + text + el.value.substring(el.selectionEnd);
        renderPreview();
    }

    function downloadExcel() {
        if (!selectedAdvisor) return alert("Select an advisor.");
        const advIdx = headers.findIndex(h => /advisor/i.test(h)) || 0;
        const clients = rawData.filter(r => r[advIdx] === selectedAdvisor);
        const exportData = [["Name", "Email", "Status", "Outlook Link"]];
        
        clients.forEach(c => {
            const name = String(c[0]).split(" ")[0];
            const email = c[headers.findIndex(h => /email/i.test(h))] || "";
            const mailto = `mailto:${email}?subject=${encodeURIComponent(document.getElementById("subjectInput").value.replace("{{FirstName}}", name).replace("{{Advisor}}", selectedAdvisor))}&body=${encodeURIComponent(document.getElementById("bodyInput").value.replace("{{FirstName}}", name).replace("{{Advisor}}", selectedAdvisor))}`;
            exportData.push([c[0], email, "Pending", { t: 's', f: `HYPERLINK("${mailto}", "Draft Email")`, v: "Draft Email" }]);
        });

        const ws = XLSX.utils.aoa_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Birthdays");
        XLSX.writeFile(wb, `${selectedAdvisor}_Birthdays.xlsx`);
    }
</script>
</body>
</html>
